<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NYC Trips Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        h1 { text-align: center; color: #333; }
        .chart-container, .filter-container { 
            width: 600px; 
            height: auto; 
            margin: 30px auto; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container h3, .filter-container h3 { margin-top: 0; color: #555; }
        #map { 
            height: 500px; 
            width: 80%; 
            margin: 50px auto; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .error-message { color: #d32f2f; text-align: center; padding: 10px; }
        .loading { text-align: center; color: #666; padding: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
        th { background-color: #eee; }
        label { display: block; margin: 10px 0; }
        input { padding: 5px; margin-left: 5px; }
        button { padding: 5px 10px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>NYC Trips Dashboard</h1>

    <!-- Filter Form -->
    <div class="filter-container">
        <h3>Filter Trips by Distance & Time</h3>
        <form id="filterForm">
            <label>Min Distance (km): <input type="number" step="0.1" id="minDistance" placeholder="0"></label>
            <label>Max Distance (km): <input type="number" step="0.1" id="maxDistance" placeholder="50"></label>
            <label>Start Time: <input type="time" id="startTime"></label>
            <label>End Time: <input type="time" id="endTime"></label>
            <button type="submit">Search</button>
        </form>
        <div id="filterResults"></div>
    </div>

    <!-- Duration by Hour -->
    <div class="chart-container">
        <h3>Trip Duration by Hour</h3>
        <div id="duration-status" class="loading">Loading...</div>
        <canvas id="durationChart"></canvas>
    </div>

    <!-- Passenger Distribution -->
    <div class="chart-container">
        <h3>Passenger Count Distribution</h3>
        <div id="passenger-status" class="loading">Loading...</div>
        <canvas id="passengerChart"></canvas>
    </div>

    <!-- Vendor Performance -->
    <div class="chart-container">
        <h3>Vendor Performance</h3>
        <div id="vendor-status" class="loading">Loading...</div>
        <canvas id="vendorChart"></canvas>
    </div>

    <!-- Heatmap -->
    <div id="map"></div>

<script>
async function renderCharts() {
    // === 1️⃣ Trip Duration by Hour ===
    try {
        const durationResp = await fetch('/trips/duration-by-hour');
        const durationData = await durationResp.json();
        if (Array.isArray(durationData) && durationData.length > 0) {
            const hours = durationData.map(d => `${d.hour}:00`);
            const avgDurations = durationData.map(d => parseFloat(d.avg_duration));
            const maxDuration = Math.max(...avgDurations);
            document.getElementById('duration-status').style.display = 'none';
            new Chart(document.getElementById('durationChart'), {
                type: 'bar',
                data: { labels: hours, datasets: [{ label: 'Avg Trip Duration (s)', data: avgDurations, backgroundColor: avgDurations.map(d => d===maxDuration?'rgba(255,99,132,0.8)':'rgba(75,192,192,0.6)') }] },
                options: { responsive:true, scales:{y:{beginAtZero:true}} }
            });
        } else { throw new Error('Invalid duration data'); }
    } catch (e) { document.getElementById('duration-status').innerHTML = '<div class="error-message">Error loading duration data</div>'; }

    // === 2️⃣ Passenger Distribution ===
    try {
        const passengerResp = await fetch('/trips/passenger-distribution');
        const passengerData = await passengerResp.json();
        if (Array.isArray(passengerData) && passengerData.length > 0) {
            const labels = passengerData.map(d => `${d.passenger_count} passenger${d.passenger_count!==1?'s':''}`);
            const data = passengerData.map(d => parseInt(d.trip_count));
            document.getElementById('passenger-status').style.display = 'none';
            new Chart(document.getElementById('passengerChart'), { type:'pie', data:{labels:labels,datasets:[{data:data,backgroundColor:['rgba(255,99,132,0.8)','rgba(54,162,235,0.8)','rgba(255,206,86,0.8)','rgba(75,192,192,0.8)','rgba(153,102,255,0.8)']}] }});
        } else { throw new Error('Invalid passenger data'); }
    } catch(e){ document.getElementById('passenger-status').innerHTML = '<div class="error-message">Error loading passenger data</div>'; }

    // === 3️⃣ Vendor Performance ===
    try {
        const vendorResp = await fetch('/trips/vendor-summary');
        const vendorData = await vendorResp.json();
        if (Array.isArray(vendorData) && vendorData.length > 0) {
            const labels = vendorData.map(d => `Vendor ${d.vendor_id}`);
            const data = vendorData.map(d => parseInt(d.total_trips));
            const maxTrips = Math.max(...data);
            document.getElementById('vendor-status').style.display='none';
            new Chart(document.getElementById('vendorChart'), { type:'bar', data:{labels:labels,datasets:[{label:'Total Trips', data:data, backgroundColor:data.map(v=>v===maxTrips?'rgba(54,162,235,0.8)':'rgba(255,159,64,0.6)')}] }});
        } else { throw new Error('Invalid vendor data'); }
    } catch(e){ document.getElementById('vendor-status').innerHTML='<div class="error-message">Error loading vendor data</div>'; }

    // === 4️⃣ Heatmap ===
    try {
        const pickupResp = await fetch('/trips/pickup-locations');
        const pickupData = await pickupResp.json();
        if (Array.isArray(pickupData) && pickupData.length>0){
            const map = L.map('map').setView([40.730610, -73.935242],11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
            const heatPoints = pickupData.filter(d=>d.pickup_latitude&&d.pickup_longitude&&d.trip_count).map(d=>[parseFloat(d.pickup_latitude),parseFloat(d.pickup_longitude),parseInt(d.trip_count)]);
            if (heatPoints.length>0) L.heatLayer(heatPoints,{radius:25,blur:15,maxZoom:17}).addTo(map);
        }
    } catch(e){ document.getElementById('map').innerHTML='<div class="error-message">Error loading map data</div>'; }
}

// === Filter Form Handling ===
document.getElementById('filterForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const minDistance = document.getElementById('minDistance').value||0;
    const maxDistance = document.getElementById('maxDistance').value||1000;
    const startTime = document.getElementById('startTime').value||'00:00';
    const endTime = document.getElementById('endTime').value||'23:59';

    try {
        const resp = await fetch(`/trips/search?min_distance=${minDistance}&max_distance=${maxDistance}&start_time=${startTime}&end_time=${endTime}`);
        const trips = await resp.json();
        const resultsDiv = document.getElementById('filterResults');
        if (!trips.length) { resultsDiv.innerHTML='<p>No trips found.</p>'; return; }

        let table = '<table><tr><th>Pickup</th><th>Dropoff</th><th>Distance (km)</th><th>Duration (s)</th></tr>';
        trips.forEach(t => { table += `<tr><td>${t.pickup_datetime}</td><td>${t.dropoff_datetime}</td><td>${t.distance}</td><td>${t.duration}</td></tr>`; });
        table+='</table>';
        resultsDiv.innerHTML = table;
    } catch(err){
        console.error(err);
        document.getElementById('filterResults').innerHTML='<p>Error fetching filtered trips</p>';
    }
});

// Run charts on page load
renderCharts();
</script>
</body>
</html>
